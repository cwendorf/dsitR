---
title: "Advanced Example"
output:
  github_document:
    preserve_yaml: FALSE
---

```{r setup, include=TRUE}
# Load necessary functions from external file
source("http://raw.githubusercontent.com/cwendorf/dsitR/main/source-dsitR.R")
```

### Conduct the Simulation

Create the agents and neighborhoods for the network.

```{r}
# Initialize a larger network with multiple opinions
agents <- create_agents(rows=10, cols=10, opinions=4)

# Use a more complex neighborhood structure
neighborhood <- create_neighborhood(agents, neighbors_moore_outside)
```

Run and verify the simulation based on the neighborhood.

```{r}
# Run a longer and slower simulation
result <- run_simulation(agents, neighborhood=neighborhood, steps=100, rate=.05)

# View the first few rows of the simulation to see what is produced
head(result)
```

### Visualize the Simulation

Visualize the a step using a force-directed graph.

```{r}
# Visualize just the initial step
frame1 <- subset(result, time==1)
plot_network(frame1,
  neighborhood=neighborhood,
  opinion="opinion1",
  main="Initial Force-Directed Network"
)
```

Visualize the entire simulation to unveil changes and patterns.

```{r}
# Animate the changes in the force-directed graph
animate_network(result,
  neighborhood=neighborhood,
  opinion="opinion1",
)
```

### Assess the Simulation

Prepare for and conduct the Principal Components extraction.

```{r}
# Extract opinions from the final frame
frame <- subset(result1, time == 100)
frame <- frame[, c("opinion1", "opinion2", "opinion3", "opinion4")]
head(frame)

# Run PCA and calculate component scores
frame_scaled <- scale(frame)
pca <- prcomp(frame_scaled, center = TRUE, scale. = TRUE)
scores <- pca$x
```

Determine the number of likely clusters in the data.

```{r}
# k-means clustering in component space
summary(pca)
pca$rotation
var_explained <- summary(pca)$importance[2,]
plot(var_explained, type="b", pch=19,
     xlab="Principal Component",
     ylab="Proportion of Variance Explained",
     main="Scree Plot")

# Choose number of clusters for later analyses
k <- 2
clusters <- kmeans(scores[,1:2], centers = k)$cluster
```

Assess the difference in component scores by cluster.

```{r}
# Boxplots of components per cluster
boxplot(scores[,1] ~ clusters,
        xlab = "Cluster", ylab = "PC1",
        main = "PC1 distribution per cluster",
        col = rainbow(k))
boxplot(scores[,2] ~ clusters,
        xlab = "Cluster", ylab = "PC2",
        main = "PC2 distribution per cluster",
        col = rainbow(k))

# Scatterplot in PC1-PC2 space, colored by clusters
plot(scores[,1], scores[,2],
     col = clusters,
     pch = 19, cex = 1.2,
     xlab = "PC1", ylab = "PC2",
     main = "Agents in PCA space with clusters")
legend("topright", legend = paste("Cluster", 1:k), col=1:k, pch=19)
```
